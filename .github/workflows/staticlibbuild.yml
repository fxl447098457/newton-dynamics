name: Build Newton Dynamics 3.13 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'newton-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  NEWTON_VERSION: 3.13

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_arch: i686
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            cmake_generator: "MinGW Makefiles"
            artifact_name: newton-dynamics-3.13-win32-static-gcc93-sjlj
            extra_flags: "-DCMAKE_C_FLAGS=-m32 -DCMAKE_CXX_FLAGS=-m32"
          - arch: x64
            msystem: MINGW64
            mingw_arch: x86_64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            cmake_generator: "MinGW Makefiles"
            artifact_name: newton-dynamics-3.13-win64-static-gcc93-sjlj
            extra_flags: ""

    name: Build ${{ matrix.arch }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Download winlibs Toolchain
      shell: pwsh
      run: |
        $url = "${{ matrix.toolchain_url }}"
        Write-Host "Downloading toolchain from: $url"
        Invoke-WebRequest -Uri $url -OutFile toolchain.7z
        7z x toolchain.7z -o"C:\winlibs" -y
        if ("${{ matrix.arch }}" -eq "x86") {
          if (-not (Test-Path "C:\winlibs\mingw32\bin\i686-w64-mingw32-gcc.exe")) {
            Write-Error "Toolchain not found!"
            exit 1
          }
        } else {
          if (-not (Test-Path "C:\winlibs\mingw64\bin\x86_64-w64-mingw32-gcc.exe")) {
            Write-Error "Toolchain not found!"
            exit 1
          }
        }

    - name: Setup MSYS2 with CMake
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          mingw-w64-${{ matrix.mingw_arch }}-toolchain
          mingw-w64-${{ matrix.mingw_arch }}-cmake
          make
          tar

    - name: Download Newton Dynamics Source
      shell: msys2 {0}
      run: |
        curl -L -o newton-dynamics.tar.gz "https://github.com/fxl447098457/newton-dynamics/releases/download/3.13/newton-dynamics-newton-3.13.tar.gz"
        tar -xzf newton-dynamics.tar.gz
        ls -la
        find . -name "CMakeLists.txt" -type f | head -5

    - name: Configure Newton Dynamics
      shell: msys2 {0}
      run: |
        # 设置工具链路径 (关键修复: 使用 Windows 风格路径)
        WINLIBS_MINGW="${{ matrix.msystem == 'MINGW32' && 'mingw32' || 'mingw64' }}"
        WINLIBS_WIN_PATH="C:\\winlibs\\$WINLIBS_MINGW"
        export WINLIBS_PATH="/c/winlibs/$WINLIBS_MINGW"
        
        # 关键修复: 使用 Windows 风格路径设置编译器
        export CC="$WINLIBS_WIN_PATH\\bin\\${{ matrix.msystem == 'MINGW32' && 'i686-w64-mingw32-gcc' || 'x86_64-w64-mingw32-gcc' }}.exe"
        export CXX="$WINLIBS_WIN_PATH\\bin\\${{ matrix.msystem == 'MINGW32' && 'i686-w64-mingw32-g++' || 'x86_64-w64-mingw32-g++' }}.exe"
        
        # 关键修复: 将 Windows 路径添加到 PATH
        export PATH="$WINLIBS_WIN_PATH\\bin:$PATH"
        
        echo "=== Compiler Paths (Windows Style) ==="
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "=== Compiler Versions ==="
        $CC --version | head -3
        $CXX --version | head -3
        echo "=== CMake Version ==="
        cmake --version
        
        SRC_DIR=$(find . -maxdepth 2 -type d -name "*newton*" | grep -v ".git" | head -1)
        if [ -z "$SRC_DIR" ]; then
          echo "ERROR: Could not find Newton source directory"
          ls -la
          exit 1
        fi
        echo "Source directory: $SRC_DIR"
        
        mkdir -p build && cd build
        
        # 核心修复: 使用 Windows 路径格式的编译器
        cmake ../$SRC_DIR \
          -G "${{ matrix.cmake_generator }}" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DCMAKE_INSTALL_PREFIX=/newton-${{ matrix.arch }} \
          -DTON_BUILD_SHARED_LIBS=OFF \
          -DNEWTON_BUILD_DEMOS=OFF \
          -DNEWTON_BUILD_SANDBOX_DEMOS=OFF \
          -DNEWTON_BUILD_PROFILER=OFF \
          ${{ matrix.extra_flags }} \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DCMAKE_POLICY_DEFAULT_CMP0150=NEW \
          || {
            echo "Fallback configuration..."
            cmake ../$SRC_DIR \
              -G "${{ matrix.cmake_generator }}" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER="$CC" \
              -DCMAKE_CXX_COMPILER="$CXX" \
              -DCMAKE_INSTALL_PREFIX=/newton-${{ matrix.arch }} \
              -DBUILD_SHARED_LIBS=OFF \
              ${{ matrix.extra_flags }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          }

    - name: Build Newton Dynamics
      shell: msys2 {0}
      run: |
        cd build
        # 使用 Windows 路径的 make
        "$WINLIBS_WIN_PATH\\bin\\mingw32-make.exe" -j$(nproc) VERBOSE=1 || {
          echo "Build failed!"
          exit 1
        }

    - name: Install Newton Dynamics
      shell: msys2 {0}
      run: |
        cd build
        "$WINLIBS_WIN_PATH\\bin\\mingw32-make.exe" install DESTDIR=/ 2>&1 | tee install.log || true
        echo "=== Installation Results ==="
        if [ -d "/newton-${{ matrix.arch }}/lib" ]; then
          ls -lh "/newton-${{ matrix.arch }}/lib/"
        else
          echo "Install directory not found, collecting from build dir..."
          find . -name "*.a" -o -name "*.lib" | head -10
        fi

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        $arch = "${{ matrix.arch }}"
        New-Item -ItemType Directory -Force -Path "$pkgName\lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "$pkgName\include" | Out-Null
        
        $installPath = "C:\msys64\newton-$arch"
        $libFiles = @()
        if (Test-Path "$installPath\lib") {
          $libFiles += Get-ChildItem -Path "$installPath\lib" -Recurse -Include "*.a","*.lib"
        }
        $libFiles += Get-ChildItem -Path "build" -Recurse -Include "*.a","*.lib" -ErrorAction SilentlyContinue
        
        foreach ($lib in ($libFiles | Sort-Object Name -Unique)) {
          Copy-Item $lib.FullName -Destination "$pkgName\lib\" -Force
        }
        
        $srcDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "*newton*" } | Select-Object -First 1
        if ($srcDir) {
          $sdkInclude = Join-Path $srcDir.FullName "newton-4.00\sdk\NewtonDynamics\include"
          if (Test-Path $sdkInclude) {
            Copy-Item "$sdkInclude\*" -Destination "$pkgName\include\" -Recurse -Force
          }
          $coreInclude = Join-Path $srcDir.FullName "coreLibrary_300\source\coreLibrary_300\include"
          if (Test-Path $coreInclude) {
            Copy-Item "$coreInclude\*" -Destination "$pkgName\include\" -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
        
        $buildInfo = "Newton Dynamics ${{ env.NEWTON_VERSION }} $arch Static Library`n" +
                     "Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)`n" +
                     "Toolchain: winlibs 9.3.0-7.0.0-r3`n" +
                     "CMake Version: $(cmake --version | Select-Object -First 1)`n" +
                     "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n" +
                     "Architecture: $arch`n" +
                     "Generator: ${{ matrix.cmake_generator }}"
        $buildInfo | Out-File -Encoding utf8 -FilePath "$pkgName\BUILD_INFO.txt"
        
        Write-Host "=== Packaging Contents ==="
        Get-ChildItem "$pkgName" -Recurse | Select-Object FullName
        
        7z a "${pkgName}.7z" "$pkgName\" -mx=9
        Compress-Archive -Path "$pkgName" -DestinationPath "${pkgName}.zip" -CompressionLevel Optimal

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: newton-dynamics-3.13-*-gcc93-sjlj
        merge-multiple: true

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
          Get-FileHash -Algorithm SHA256 | 
          ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
          Out-File -Encoding utf8 $checksumFile
        $content = (Get-Content $checksumFile -Raw).Trim()
        "content<<EOF`n$content`nEOF" | Out-File -Append $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Newton Dynamics ${{ env.NEWTON_VERSION }} Windows (GCC 9.3 SJLJ) ${{ github.ref_name }}
        body: |
          ## Newton Dynamics 3.13 Windows 静态库 (GCC 9.3 SJLJ)
          
          ### 编译器信息
          - **版本**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **异常处理**: SJLJ (SetJump/LongJump) - 适合需要 32 位兼容的场景
          - **构建环境**: Windows Server + MSYS2
          - **CMake**: 4.2.3
          - **生成器**: MinGW Makefiles
          
          ### 包含内容
          - `newton-dynamics-3.13-win32-static-gcc93-sjlj`: x86 32位静态库（含 `-m32` 标志）
          - `newton-dynamics-3.13-win64-static-gcc93-sjlj`: x86_64 64位静态库
          - 头文件（`include/` 目录）
          - 静态库（`lib/` 目录，`.a` 格式）
          
          ### 链接依赖
          静态链接时需添加系统库：
          ```cmake
          target_link_libraries(your_target 
            newton
            winmm
            ws2_32
            imm32
          )
          ```
          
          ### SHA256 校验和
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
