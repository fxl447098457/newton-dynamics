name: Build Newton Dynamics 3.13 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'newton-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  NEWTON_VERSION: 3.13

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_arch: i686
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z 
            cmake_generator: "MinGW Makefiles"
            artifact_name: newton-dynamics-3.13-win32-static-gcc93-sjlj
            extra_flags: "-DCMAKE_C_FLAGS=-m32 -DCMAKE_CXX_FLAGS=-m32"
            gcc_prefix: i686-w64-mingw32
          - arch: x64
            msystem: MINGW64
            mingw_arch: x86_64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z 
            cmake_generator: "MinGW Makefiles"
            artifact_name: newton-dynamics-3.13-win64-static-gcc93-sjlj
            extra_flags: ""
            gcc_prefix: x86_64-w64-mingw32

    name: Build ${{ matrix.arch }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ðŸ”§ ä¿®å¤ï¼šå°†å·¥å…·é“¾ä¸‹è½½å’Œè®¾ç½®åˆå¹¶åˆ°ä¸€æ­¥ï¼Œå¹¶æ­£ç¡®æ·»åŠ åˆ° PATH
    - name: Setup winlibs Toolchain
      shell: pwsh
      id: setup_toolchain  # ðŸ”§ æ·»åŠ  id ä»¥ä¾¿åŽç»­å¼•ç”¨
      run: |
        $url = "${{ matrix.toolchain_url }}"
        Write-Host "Downloading toolchain from: $url"
        
        # åˆ›å»ºå·¥å…·é“¾ç›®å½•
        $toolchainDir = "C:\winlibs"
        New-Item -ItemType Directory -Force -Path $toolchainDir | Out-Null
        
        # ä¸‹è½½å¹¶è§£åŽ‹
        Invoke-WebRequest -Uri $url -OutFile toolchain.7z
        7z x toolchain.7z -o"$toolchainDir" -y
        
        # éªŒè¯è§£åŽ‹åŽçš„è·¯å¾„
        $mingwDir = if ("${{ matrix.arch }}" -eq "x86") { "mingw32" } else { "mingw64" }
        $gccPrefix = if ("${{ matrix.arch }}" -eq "x86") { "i686-w64-mingw32" } else { "x86_64-w64-mingw32" }
        $gccExe = Join-Path $toolchainDir "$mingwDir\bin\$gccPrefix-gcc.exe"
        
        if (-not (Test-Path $gccExe)) {
          Write-Error "GCC not found at expected path: $gccExe"
          Get-ChildItem -Path (Join-Path $toolchainDir $mingwDir) -Recurse -Filter "*.exe" | Select-Object -First 10
          exit 1
        }
        
        Write-Host "Found GCC at: $gccExe"
        
        # å°†å·¥å…·é“¾è·¯å¾„æ·»åŠ åˆ° GITHUB_PATH ä»¥ä¾¿åŽç»­æ­¥éª¤ä½¿ç”¨
        $binPath = Join-Path $toolchainDir "$mingwDir\bin"
        Add-Content -Path $env:GITHUB_PATH -Value $binPath
        
        # ðŸ”§ ä¿®å¤ï¼šä½¿ç”¨ GITHUB_OUTPUT è€Œä¸æ˜¯ GITHUB_ENV æ¥ä¼ é€’å€¼ç»™åŽç»­æ­¥éª¤çš„ env å—
        Add-Content -Path $env:GITHUB_OUTPUT -Value "winlibs_path=$binPath"
        Add-Content -Path $env:GITHUB_OUTPUT -Value "gcc_prefix=$gccPrefix"

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          make
          mingw-w64-${{ matrix.mingw_arch }}-cmake
          mingw-w64-${{ matrix.mingw_arch }}-ninja

    - name: Download Newton Dynamics Source
      shell: msys2 {0}
      run: |
        curl -L -o newton-dynamics.tar.gz "https://github.com/fxl447098457/newton-dynamics/releases/download/3.13/newton-dynamics-newton-3.13.tar.gz"
        tar -xzf newton-dynamics.tar.gz
        ls -la
        find . -name "CMakeLists.txt" -type f | head -5

    - name: Configure Newton Dynamics
      shell: msys2 {0}
      env:
        # ðŸ”§ ä¿®å¤ï¼šä½¿ç”¨ steps ä¸Šä¸‹æ–‡å¼•ç”¨ä¸Šä¸€æ­¥çš„è¾“å‡ºï¼Œè€Œä¸æ˜¯ env ä¸Šä¸‹æ–‡
        WINLIBS_BIN: ${{ steps.setup_toolchain.outputs.winlibs_path }}
        GCC_PREFIX: ${{ steps.setup_toolchain.outputs.gcc_prefix }}
      run: |
        # è½¬æ¢ Windows è·¯å¾„ä¸º MSYS2 æ ¼å¼
        WINLIBS_MSYS=$(cygpath -u "$WINLIBS_BIN")
        echo "Winlibs MSYS path: $WINLIBS_MSYS"
        
        # æ·»åŠ åˆ° PATH (ç¡®ä¿åœ¨æœ€å‰é¢)
        export PATH="$WINLIBS_MSYS:$PATH"
        
        # éªŒè¯å·¥å…·é“¾
        echo "=== PATH (first 5 entries) ==="
        echo "$PATH" | tr ':' '\n' | head -5
        
        echo "=== Compiler Check ==="
        which ${GCC_PREFIX}-gcc || { echo "GCC not found!"; exit 1; }
        which ${GCC_PREFIX}-g++ || { echo "G++ not found!"; exit 1; }
        which mingw32-make || { echo "mingw32-make not found!"; exit 1; }
        
        echo "=== Compiler Versions ==="
        ${GCC_PREFIX}-gcc --version | head -2
        ${GCC_PREFIX}-g++ --version | head -2
        
        # æŸ¥æ‰¾æºç ç›®å½•
        SRC_DIR=$(find . -maxdepth 2 -type d -name "*newton*" | grep -v ".git" | head -1)
        if [ -z "$SRC_DIR" ]; then
          echo "ERROR: Could not find Newton source directory"
          ls -la
          exit 1
        fi
        echo "Source directory: $SRC_DIR"
        
        mkdir -p build && cd build
        
        # ä½¿ç”¨æ­£ç¡®çš„ç¼–è¯‘å™¨åç§°
        cmake ../$SRC_DIR \
          -G "${{ matrix.cmake_generator }}" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER="${GCC_PREFIX}-gcc" \
          -DCMAKE_CXX_COMPILER="${GCC_PREFIX}-g++" \
          -DCMAKE_RC_COMPILER="${GCC_PREFIX}-windres" \
          -DCMAKE_INSTALL_PREFIX=/newton-${{ matrix.arch }} \
          -DNEWTON_BUILD_SHARED_LIBS=OFF \
          -DNEWTON_BUILD_DEMOS=OFF \
          -DNEWTON_BUILD_SANDBOX_DEMOS=OFF \
          -DNEWTON_BUILD_PROFILER=OFF \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          ${{ matrix.extra_flags }}

    - name: Build Newton Dynamics
      shell: msys2 {0}
      env:
        # ðŸ”§ ä¿®å¤ï¼šåŒæ ·ä½¿ç”¨ steps ä¸Šä¸‹æ–‡
        WINLIBS_BIN: ${{ steps.setup_toolchain.outputs.winlibs_path }}
        GCC_PREFIX: ${{ steps.setup_toolchain.outputs.gcc_prefix }}
      run: |
        # é‡æ–°è®¾ç½® PATH
        WINLIBS_MSYS=$(cygpath -u "$WINLIBS_BIN")
        export PATH="$WINLIBS_MSYS:$PATH"
        
        # éªŒè¯
        which ${GCC_PREFIX}-gcc || { echo "GCC not found!"; exit 1; }
        which mingw32-make || { echo "mingw32-make not found!"; exit 1; }
        
        cd build
        mingw32-make -j$(nproc) VERBOSE=1

    - name: Install Newton Dynamics
      shell: msys2 {0}
      env:
        # ðŸ”§ ä¿®å¤ï¼šåŒæ ·ä½¿ç”¨ steps ä¸Šä¸‹æ–‡
        WINLIBS_BIN: ${{ steps.setup_toolchain.outputs.winlibs_path }}
      run: |
        WINLIBS_MSYS=$(cygpath -u "$WINLIBS_BIN")
        export PATH="$WINLIBS_MSYS:$PATH"
        
        cd build
        mingw32-make install DESTDIR=/ 2>&1 | tee install.log || true
        
        echo "=== Installation Results ==="
        if [ -d "/newton-${{ matrix.arch }}/lib" ]; then
          ls -lh "/newton-${{ matrix.arch }}/lib/"
        else
          echo "Install directory not found, collecting from build dir..."
          find . -name "*.a" -o -name "*.lib" | head -10
        fi

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        $arch = "${{ matrix.arch }}"
        New-Item -ItemType Directory -Force -Path "$pkgName\lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "$pkgName\include" | Out-Null
        
        $installPath = "C:\msys64\newton-$arch"
        $libFiles = @()
        if (Test-Path "$installPath\lib") {
          $libFiles += Get-ChildItem -Path "$installPath\lib" -Recurse -Include "*.a","*.lib"
        }
        $libFiles += Get-ChildItem -Path "build" -Recurse -Include "*.a","*.lib" -ErrorAction SilentlyContinue
        
        foreach ($lib in ($libFiles | Sort-Object Name -Unique)) {
          Copy-Item $lib.FullName -Destination "$pkgName\lib\" -Force
        }
        
        $srcDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "*newton*" } | Select-Object -First 1
        if ($srcDir) {
          $sdkInclude = Join-Path $srcDir.FullName "newton-4.00\sdk\NewtonDynamics\include"
          if (Test-Path $sdkInclude) {
            Copy-Item "$sdkInclude\*" -Destination "$pkgName\include\" -Recurse -Force
          }
          $coreInclude = Join-Path $srcDir.FullName "coreLibrary_300\source\coreLibrary_300\include"
          if (Test-Path $coreInclude) {
            Copy-Item "$coreInclude\*" -Destination "$pkgName\include\" -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
        
        $buildInfo = "Newton Dynamics ${{ env.NEWTON_VERSION }} $arch Static Library`n" +
                     "Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)`n" +
                     "Toolchain: winlibs 9.3.0-7.0.0-r3`n" +
                     "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n" +
                     "Architecture: $arch`n" +
                     "Generator: ${{ matrix.cmake_generator }}"
        $buildInfo | Out-File -Encoding utf8 -FilePath "$pkgName\BUILD_INFO.txt"
        
        Write-Host "=== Packaging Contents ==="
        Get-ChildItem "$pkgName" -Recurse | Select-Object FullName
        
        7z a "${pkgName}.7z" "$pkgName\" -mx=9
        Compress-Archive -Path "$pkgName" -DestinationPath "${pkgName}.zip" -CompressionLevel Optimal

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    # ðŸ”§ æ–°å¢žï¼šæ£€å‡ºä»£ç ï¼ˆéœ€è¦ token æ¥æŽ¨é€ tagï¼‰
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿æ‰“ tag
    # ðŸ”§ å…³é”®ï¼šæ‰‹åŠ¨è§¦å‘æ—¶è‡ªåŠ¨åˆ›å»º tag
    - name: Create Tag for Manual Release
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
      shell: bash
      run: |
        TAG_NAME="build-$(date +%Y%m%d-%H%M%S)"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"
        echo "RELEASE_TAG=$TAG_NAME" >> $GITHUB_ENV
        echo "Created tag: $TAG_NAME"

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: newton-dynamics-3.13-*-gcc93-sjlj
        merge-multiple: true

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
          Get-FileHash -Algorithm SHA256 | 
          ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
          Out-File -Encoding utf8 $checksumFile
        $content = (Get-Content $checksumFile -Raw).Trim()
        "content<<EOF`n$content`nEOF" | Out-File -Append $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        # ðŸ”§ å…³é”®ï¼šä½¿ç”¨è‡ªåŠ¨åˆ›å»ºçš„ tag æˆ–å·²æœ‰çš„ tag
        tag_name: ${{ env.RELEASE_TAG || github.ref_name }}
        name: Newton Dynamics ${{ env.NEWTON_VERSION }} Windows (GCC 9.3 SJLJ) ${{ env.RELEASE_TAG || github.ref_name }}
        body: |
          ## Newton Dynamics 3.13 Windows é™æ€åº“ (GCC 9.3 SJLJ)
          
          ${{ github.event_name == 'workflow_dispatch' && '**æ‰‹åŠ¨è§¦å‘æž„å»º**' || '' }}
          
          ### ç¼–è¯‘å™¨ä¿¡æ¯
          - **ç‰ˆæœ¬**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **å¼‚å¸¸å¤„ç†**: SJLJ (SetJump/LongJump)
          - **æž¶æž„**: x86 / x64
          
          ### SHA256 æ ¡éªŒå’Œ
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
